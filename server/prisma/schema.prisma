// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                String   @id @default(uuid())
  businessName      String
  businessType      String?
  employeeCount     String?
  industry          String?
  country           String?
  selectedModules   String[]
  primaryGoal       String?
  cloudProvider     String?
  region            String?
  storageVolume     Int?
  compression       Boolean  @default(false)
  activeHours       Int?
  integrations      String[]
  selectedPlan      String?
  billingCycle      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  users             User[]
  branches          Branch[]
  departments       Department[]
  permissions       UserPermission[]
  auditLogs         AuditLog[]

  @@index([businessName])
}

model User {
  id                String    @id @default(uuid())
  organizationId    String
  email             String
  passwordHash      String?
  firstName         String
  lastName          String
  phone             String?
  role              UserRole
  googleId          String?   @unique
  emailVerified     Boolean   @default(false)
  mfaEnabled        Boolean   @default(false)
  mfaSecret         String?
  backupCodes       String[]
  passwordHistory   String[]
  accountLocked     Boolean   @default(false)
  lockUntil         DateTime?
  createdById       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?

  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator           User?        @relation("UserHierarchy", fields: [createdById], references: [id])
  subordinates      User[]       @relation("UserHierarchy")
  
  permissions       UserPermission[]
  branchAssignments UserBranchAssignment[]
  deptAssignments   UserDepartmentAssignment[]
  refreshTokens     RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  auditLogs         AuditLog[]

  @@unique([email, organizationId])
  @@index([organizationId, id])
  @@index([organizationId, email])
  @@index([organizationId, role])
  @@index([createdById])
}

enum UserRole {
  OWNER
  MANAGER
  WORKER
}

model Branch {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  location       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userAssignments UserBranchAssignment[]

  @@unique([organizationId, name])
  @@index([organizationId, id])
}

model Department {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userAssignments UserDepartmentAssignment[]

  @@unique([organizationId, name])
  @@index([organizationId, id])
}

model UserBranchAssignment {
  id             String   @id @default(uuid())
  userId         String
  branchId       String
  assignedAt     DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch         Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([userId, branchId])
  @@index([userId])
  @@index([branchId])
}

model UserDepartmentAssignment {
  id             String     @id @default(uuid())
  userId         String
  departmentId   String
  assignedAt     DateTime   @default(now())

  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
  @@index([userId])
  @@index([departmentId])
}

model Permission {
  id          String   @id @default(uuid())
  key         String   @unique
  module      String
  resource    String
  action      String
  description String
  createdAt   DateTime @default(now())

  @@index([module])
  @@index([key])
}

model UserPermission {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  permission     String
  grantedById    String
  grantedAt      DateTime @default(now())

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId, permission])
  @@index([userId, organizationId])
  @@index([organizationId])
}

model RefreshToken {
  id             String   @id @default(uuid())
  userId         String
  token          String   @unique
  familyId       String
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  revokedAt      DateTime?

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyId])
  @@index([token])
}

model PasswordResetToken {
  id             String   @id @default(uuid())
  userId         String
  token          String   @unique
  expiresAt      DateTime
  usedAt         DateTime?
  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Session {
  id             String   @id @default(uuid())
  sessionId      String   @unique
  userId         String
  organizationId String
  deviceInfo     String
  ipAddress      String
  lastActive     DateTime @default(now())
  createdAt      DateTime @default(now())
  expiresAt      DateTime

  @@index([userId])
  @@index([sessionId])
  @@index([userId, organizationId])
}

model AuditLog {
  id             String   @id @default(uuid())
  organizationId String
  userId         String?
  action         String
  entityType     String?
  entityId       String?
  metadata       Json
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([userId])
  @@index([action])
}
