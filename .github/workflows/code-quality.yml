name: Code Quality Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run code quality analysis daily at 1 AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18.19.0'
  PNPM_VERSION: '8.15.0'

jobs:
  # SonarCloud Analysis
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm run test:coverage
        env:
          NODE_ENV: test

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ESLint Analysis
  eslint:
    name: ESLint Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: |
          pnpm run lint --format=@microsoft/eslint-formatter-sarif --output-file=eslint-results.sarif
        continue-on-error: true

      - name: Upload ESLint results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: eslint-results.sarif
          wait-for-processing: true

  # TypeScript Strict Mode Analysis
  typescript-strict:
    name: TypeScript Strict Mode Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check TypeScript strict mode compliance
        run: |
          # Check each package for strict mode compliance
          for package in packages/*/tsconfig.json apps/*/tsconfig.json; do
            if [ -f "$package" ]; then
              echo "Checking $package for strict mode..."
              if ! grep -q '"strict": true' "$package"; then
                echo "::warning::$package does not have strict mode enabled"
              fi
            fi
          done

      - name: Run TypeScript compiler with strict checks
        run: pnpm run type-check:strict

      - name: Check for any types
        run: |
          echo "Checking for 'any' types..."
          any_count=$(find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs grep -n ": any" | wc -l)
          echo "Found $any_count instances of 'any' type"
          if [ $any_count -gt 0 ]; then
            echo "::warning::Found $any_count instances of 'any' type. Consider using more specific types."
          fi

  # Code Complexity Analysis
  complexity:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install complexity analysis tools
        run: |
          npm install -g complexity-report
          npm install -g jscpd

      - name: Run complexity analysis
        run: |
          # Generate complexity report
          cr --format json --output complexity-report.json apps/ packages/

          # Generate duplicate code report
          jscpd --format json --output jscpd-report.json apps/ packages/

      - name: Analyze complexity results
        run: |
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('complexity-report.json', 'utf8'));
            
            let highComplexityFiles = [];
            report.reports.forEach(file => {
              if (file.complexity.cyclomatic > 10) {
                highComplexityFiles.push({
                  path: file.path,
                  complexity: file.complexity.cyclomatic
                });
              }
            });
            
            if (highComplexityFiles.length > 0) {
              console.log('::warning::High complexity files found:');
              highComplexityFiles.forEach(file => {
                console.log(\`::warning::\${file.path} has cyclomatic complexity of \${file.complexity}\`);
              });
            }
          "

      - name: Upload complexity reports
        uses: actions/upload-artifact@v3
        with:
          name: complexity-reports
          path: |
            complexity-report.json
            jscpd-report.json
          retention-days: 30

  # Documentation Quality
  documentation:
    name: Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install documentation tools
        run: |
          npm install -g documentation
          npm install -g markdownlint-cli

      - name: Check README files
        run: |
          # Check if all packages have README files
          for dir in packages/*/; do
            if [ ! -f "$dir/README.md" ]; then
              echo "::warning::Missing README.md in $dir"
            fi
          done

          for dir in apps/*/; do
            if [ ! -f "$dir/README.md" ]; then
              echo "::warning::Missing README.md in $dir"
            fi
          done

      - name: Lint markdown files
        run: |
          markdownlint "**/*.md" --ignore node_modules --ignore .git

      - name: Check JSDoc coverage
        run: |
          # Generate JSDoc documentation and check coverage
          documentation build packages/*/src/**/*.ts --format json --output jsdoc-coverage.json

          node -e "
            const fs = require('fs');
            if (fs.existsSync('jsdoc-coverage.json')) {
              const docs = JSON.parse(fs.readFileSync('jsdoc-coverage.json', 'utf8'));
              const totalFunctions = docs.filter(item => item.kind === 'function').length;
              const documentedFunctions = docs.filter(item => 
                item.kind === 'function' && item.description && item.description.length > 0
              ).length;
              
              const coverage = totalFunctions > 0 ? (documentedFunctions / totalFunctions * 100).toFixed(2) : 0;
              console.log(\`JSDoc coverage: \${coverage}% (\${documentedFunctions}/\${totalFunctions} functions)\`);
              
              if (coverage < 80) {
                console.log('::warning::JSDoc coverage is below 80%');
              }
            }
          "

  # Accessibility Analysis
  accessibility:
    name: Accessibility Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run accessibility linting
        run: |
          # Check for accessibility issues in React components
          pnpm run lint:a11y
        continue-on-error: true

      - name: Check for accessibility attributes
        run: |
          echo "Checking for accessibility attributes..."

          # Check for alt attributes on images
          missing_alt=$(find apps/web packages/ui -name "*.tsx" -o -name "*.jsx" | xargs grep -l "<img" | xargs grep -L "alt=")
          if [ ! -z "$missing_alt" ]; then
            echo "::warning::Images without alt attributes found in: $missing_alt"
          fi

          # Check for aria-label or aria-labelledby on interactive elements
          interactive_files=$(find apps/web packages/ui -name "*.tsx" -o -name "*.jsx" | xargs grep -l "onClick\|onKeyDown\|button\|input")
          for file in $interactive_files; do
            if ! grep -q "aria-label\|aria-labelledby" "$file"; then
              echo "::warning::Interactive elements without ARIA labels in: $file"
            fi
          done

  # Performance Budget Check
  performance-budget:
    name: Performance Budget Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web application
        run: pnpm run build --filter=web

      - name: Analyze bundle size
        run: |
          # Check bundle sizes against performance budget
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const buildDir = 'apps/web/.next/static';
            if (fs.existsSync(buildDir)) {
              const getDirectorySize = (dir) => {
                let size = 0;
                const files = fs.readdirSync(dir);
                files.forEach(file => {
                  const filePath = path.join(dir, file);
                  const stats = fs.statSync(filePath);
                  if (stats.isDirectory()) {
                    size += getDirectorySize(filePath);
                  } else {
                    size += stats.size;
                  }
                });
                return size;
              };
              
              const totalSize = getDirectorySize(buildDir);
              const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
              
              console.log(\`Total bundle size: \${sizeMB} MB\`);
              
              // Performance budget: 5MB
              if (totalSize > 5 * 1024 * 1024) {
                console.log('::error::Bundle size exceeds 5MB performance budget');
                process.exit(1);
              }
            }
          "

      - name: Check for large dependencies
        run: |
          # Analyze package sizes
          npx bundle-phobia-cli --json > bundle-sizes.json

          node -e "
            const fs = require('fs');
            if (fs.existsSync('bundle-sizes.json')) {
              const sizes = JSON.parse(fs.readFileSync('bundle-sizes.json', 'utf8'));
              
              sizes.forEach(pkg => {
                if (pkg.size > 1024 * 1024) { // 1MB
                  console.log(\`::warning::Large dependency: \${pkg.name} (\${(pkg.size / 1024 / 1024).toFixed(2)} MB)\`);
                }
              });
            }
          "
