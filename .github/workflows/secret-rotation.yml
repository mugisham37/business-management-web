name: Secret Rotation

on:
  schedule:
    # Run secret rotation check daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_rotation:
        description: 'Force rotation of all secrets'
        required: false
        default: 'false'
        type: boolean
      secret_name:
        description: 'Specific secret to rotate (optional)'
        required: false
        type: string

concurrency:
  group: secret-rotation
  cancel-in-progress: false

env:
  NODE_VERSION: '18.19.0'
  PNPM_VERSION: '8.15.0'

jobs:
  check-rotation:
    name: Check Secret Rotation
    runs-on: ubuntu-latest
    outputs:
      needs-rotation: ${{ steps.check.outputs.needs-rotation }}
      secrets-list: ${{ steps.check.outputs.secrets-list }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check secrets rotation status
        id: check
        run: |
          # Build the config package to use secret management
          pnpm run build --filter=@company/config

          # Run secret rotation check
          node -e "
            const { SecretsManager } = require('./packages/config/dist/secrets/secrets-manager.js');
            const manager = new SecretsManager();
            
            (async () => {
              try {
                const needsRotation = await manager.checkRotationNeeded();
                const forceRotation = '${{ github.event.inputs.force_rotation }}' === 'true';
                const specificSecret = '${{ github.event.inputs.secret_name }}';
                
                let secretsToRotate = needsRotation;
                
                if (forceRotation) {
                  const allSecrets = await manager.listSecrets();
                  secretsToRotate = allSecrets;
                } else if (specificSecret) {
                  const allSecrets = await manager.listSecrets();
                  secretsToRotate = allSecrets.filter(s => s.name === specificSecret);
                }
                
                const needsRotationFlag = secretsToRotate.length > 0 ? 'true' : 'false';
                const secretsList = JSON.stringify(secretsToRotate.map(s => s.name));
                
                console.log('needs-rotation=' + needsRotationFlag);
                console.log('secrets-list=' + secretsList);
                
                // Set GitHub outputs
                require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 
                  'needs-rotation=' + needsRotationFlag + '\n' +
                  'secrets-list=' + secretsList + '\n'
                );
                
                if (secretsToRotate.length > 0) {
                  console.log('Secrets needing rotation:', secretsList);
                } else {
                  console.log('No secrets need rotation at this time');
                }
              } catch (error) {
                console.error('Error checking secret rotation:', error);
                process.exit(1);
              }
            })();
          "

  rotate-database-secrets:
    name: Rotate Database Secrets
    runs-on: ubuntu-latest
    needs: check-rotation
    if: needs.check-rotation.outputs.needs-rotation == 'true'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Rotate database password
        if: contains(needs.check-rotation.outputs.secrets-list, 'DATABASE_PASSWORD')
        run: |
          # Generate new database password
          NEW_PASSWORD=$(openssl rand -base64 32)

          # Update password in database
          PGPASSWORD="${{ secrets.DATABASE_PASSWORD }}" psql \
            -h "${{ secrets.DATABASE_HOST }}" \
            -U "${{ secrets.DATABASE_USER }}" \
            -d "${{ secrets.DATABASE_NAME }}" \
            -c "ALTER USER ${{ secrets.DATABASE_USER }} PASSWORD '$NEW_PASSWORD';"

          # Store new password in secret manager
          node -e "
            const { SecretsManager } = require('./packages/config/dist/secrets/secrets-manager.js');
            const manager = new SecretsManager();
            
            (async () => {
              await manager.storeSecret('DATABASE_PASSWORD', '$NEW_PASSWORD', {
                description: 'Rotated database password',
                tags: ['database', 'rotated'],
                rotationPolicy: {
                  enabled: true,
                  intervalDays: 90
                }
              });
              console.log('Database password rotated successfully');
            })();
          "

      - name: Update Vault secrets
        if: env.VAULT_ENDPOINT
        env:
          VAULT_ENDPOINT: ${{ secrets.VAULT_ENDPOINT }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
        run: |
          # Update secrets in HashiCorp Vault
          node -e "
            const { VaultSecretProvider } = require('./packages/config/dist/secrets/vault-integration.js');
            const vault = new VaultSecretProvider({
              endpoint: process.env.VAULT_ENDPOINT,
              token: process.env.VAULT_TOKEN
            });
            
            (async () => {
              const secretsList = JSON.parse('${{ needs.check-rotation.outputs.secrets-list }}');
              
              for (const secretName of secretsList) {
                if (secretName.includes('PASSWORD') || secretName.includes('SECRET')) {
                  const newValue = require('crypto').randomBytes(32).toString('base64');
                  await vault.setSecret(secretName, newValue);
                  console.log('Rotated secret in Vault:', secretName);
                }
              }
            })();
          "

  rotate-api-keys:
    name: Rotate API Keys
    runs-on: ubuntu-latest
    needs: check-rotation
    if: needs.check-rotation.outputs.needs-rotation == 'true'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Rotate JWT secrets
        if: contains(needs.check-rotation.outputs.secrets-list, 'JWT_SECRET')
        run: |
          # Generate new JWT secret
          NEW_JWT_SECRET=$(openssl rand -base64 64)

          # Store new JWT secret
          node -e "
            const { SecretsManager } = require('./packages/config/dist/secrets/secrets-manager.js');
            const manager = new SecretsManager();
            
            (async () => {
              await manager.storeSecret('JWT_SECRET', '$NEW_JWT_SECRET', {
                description: 'Rotated JWT signing secret',
                tags: ['jwt', 'auth', 'rotated'],
                rotationPolicy: {
                  enabled: true,
                  intervalDays: 30
                }
              });
              console.log('JWT secret rotated successfully');
            })();
          "

      - name: Rotate OAuth client secrets
        run: |
          # This would integrate with OAuth providers to rotate client secrets
          # Implementation depends on specific OAuth providers (Google, GitHub, etc.)
          echo "OAuth client secret rotation would be implemented here"

  notify-rotation:
    name: Notify Secret Rotation
    runs-on: ubuntu-latest
    needs: [check-rotation, rotate-database-secrets, rotate-api-keys]
    if: always() && needs.check-rotation.outputs.needs-rotation == 'true'
    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ðŸ”„ Secret Rotation Completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Secret Rotation Status*\n\nRotated secrets: ${{ needs.check-rotation.outputs.secrets-list }}\n\nDatabase rotation: ${{ needs.rotate-database-secrets.result }}\nAPI keys rotation: ${{ needs.rotate-api-keys.result }}"
                  }
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL

      - name: Create GitHub issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Secret Rotation Failed',
              body: `Secret rotation workflow failed on ${new Date().toISOString()}\n\nPlease check the workflow logs and rotate secrets manually if necessary.\n\nSecrets that needed rotation: ${{ needs.check-rotation.outputs.secrets-list }}`,
              labels: ['security', 'urgent']
            });

  security-scan-post-rotation:
    name: Security Scan After Rotation
    runs-on: ubuntu-latest
    needs: [rotate-database-secrets, rotate-api-keys]
    if: always() && (needs.rotate-database-secrets.result == 'success' || needs.rotate-api-keys.result == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run security scan
        uses: ./.github/workflows/security.yml
        with:
          trigger: post-rotation

      - name: Verify secret accessibility
        run: |
          # Test that rotated secrets are accessible and valid
          node -e "
            const { SecretsManager } = require('./packages/config/dist/secrets/secrets-manager.js');
            const manager = new SecretsManager();
            
            (async () => {
              const secrets = ['DATABASE_PASSWORD', 'JWT_SECRET', 'REDIS_PASSWORD'];
              
              for (const secretName of secrets) {
                const value = await manager.getSecret(secretName);
                if (value) {
                  console.log('âœ“ Secret accessible:', secretName);
                } else {
                  console.error('âœ— Secret not accessible:', secretName);
                  process.exit(1);
                }
              }
              
              console.log('All rotated secrets are accessible');
            })();
          "
